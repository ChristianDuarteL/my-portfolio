---
import { Icon } from 'astro-icon/components';
---
<dialog aria-label="Coupon" role="dialog" tabindex="-1" coupon-dialog>
    <div class="fixed inset-0 z-10 overflow-hidden">
        <div class="absolute inset-0 bg-noise opacity-75 brightness-100"></div>
        <div class="absolute inset-0">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="container max-w-2xl mx-auto flex flex-col gap-14">
                    <div class="atropos">
                        <!-- scale container (required) -->
                        <div class="atropos-scale">
                            <!-- rotate container (required) -->
                            <div class="atropos-rotate">
                                <!-- inner container (required) -->
                                <div class="atropos-inner">
                                    <div class="absolute w-full" coupon-image></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex rounded-md p-1 relative gap-1 justify-between">
                        <button class="z-10 py-2 px-4 rounded-0 flex justify-center items-center relative border-[#333] border-1 bg-white flex-1 max-w-50" tabindex="2"> 
                            <div class="absolute bg-noise inset-0 opacity-50"></div>
                            <div class="flex justify-center items-center gap-1 z-10">
                                <Icon name="shredder"></Icon> <span class="self-end leading-3.5">Shred</span> 
                            </div>
                        </button>
                        <button class="z-10 py-2 px-4 rounded-0 flex justify-center items-center border-[#333] border-2 bg-[#f5eedc] border-dashed relative flex-1 max-w-50" tabindex="1" autofocus >
                            <div class="absolute bg-noise inset-0 opacity-50"></div>
                            <div class="flex justify-center items-center gap-1 z-10">
                                <Icon name="floppy-disk"></Icon> <span class="self-end leading-3.5">Save</span> 
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</dialog>

<script>
    import { Flip } from 'gsap/Flip';
    import gsap from 'gsap';
    import Atropos from 'atropos';
    import { CouponClickedEvent } from '@/lib/coupons';
    import type Coupon from '@/types/coupon';
    import { makeCoupon } from '@/lib/coupons';
    import { COUPONS } from '@/consts/coupons';
    
    gsap.registerPlugin(Flip);

    export function runDialog(coupon: Coupon, el?: HTMLElement) {
        const dialog = document.querySelector('[coupon-dialog]') as HTMLDialogElement;
        if (dialog) {
            dialog.showModal();
        }

        const inner = dialog.querySelector('.atropos-inner') as HTMLElement;
        const couponCont = el?.querySelector('[coupon-container]') as HTMLElement | undefined;
        const couponImage = dialog.querySelector('[coupon-image]') as HTMLElement;
        //couponImage.style.aspectRatio = `${coupon.width} / ${coupon.height}`;
        inner.style.aspectRatio = `${coupon.width} / ${coupon.height}`;
        const newCoupon = makeCoupon(coupon);
        couponImage.appendChild(newCoupon);

        const state = Flip.getState(newCoupon);
        if(couponCont) {
            Flip.fit(newCoupon, couponCont);
        }
        console.log(state);
        inner.style.overflow = 'visible';
        Flip.to(state, {
            duration: .5,
            paused: true,
            absolute: true,
        }).play().then(() => {
            inner.style.overflow = 'hidden';

            const couponAtropos = Atropos({
                el: dialog.querySelector('.atropos')! as HTMLElement,
                alwaysActive: true,
            });
        });
    }
    

    window.addEventListener('show-coupon', (event) => {
        if(!(event instanceof CouponClickedEvent)) return;
        runDialog(event.coupon, event.couponElement);
    });
    runDialog(COUPONS[1]);
</script>

<style>
</style>